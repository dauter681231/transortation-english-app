<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸­è‹±èªé›™æ¨¡å¼æŒ‘æˆ°å¹³å°</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”å’Œæ•´é«”èƒŒæ™¯ */
        body { font-family: 'Inter', sans-serif; background-color: #f7ffee; }
        .app-container { min-height: 80vh; }

        /* å–®å­—å¡ç‰‡æ¨£å¼ (ç°¡åŒ–ç‚ºéœæ…‹é¡¯ç¤º) */
        .flashcard-static {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 10rem;
            background-color: #8b5cf6; /* ç´«è‰² */
            color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* æ‰“å­—æ©Ÿæ•ˆæœ - å–®å­—æ¸¬é©— */
        .typewriter-text {
            border-right: .15em solid #f97316;
            animation: 
                typing 3s steps(30, end) forwards,
                blink-caret .75s step-end infinite;
            white-space: nowrap;
            overflow: hidden;
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: #f97316; } }

        /* æ‹–æ›³å‹•ç•« - æ–‡æ³•å¡«ç©º */
        .drop-zone { min-height: 3.5rem; border: 3px dashed #a78bfa; transition: all 0.2s; }
        .drag-item { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .drag-item.correct-animation { animation: bounce-in 0.8s ease-out; }
        .drag-item.incorrect-animation { animation: shake 0.5s; }
        @keyframes bounce-in { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

<div id="app" class="max-w-4xl mx-auto bg-white p-6 rounded-3xl shadow-2xl app-container">
    
    <!-- æ¨™é¡Œèˆ‡æ¨¡å¼åˆ‡æ›å€ -->
    <header class="text-center mb-8 border-b-2 pb-4">
        <h1 class="text-4xl font-extrabold text-purple-700 mb-2">ğŸ“ åœ‹ä¸­è‹±èªæŒ‘æˆ°å¹³å° ğŸš€</h1>
        <p class="text-lg text-gray-600">Unit 5: How Do We Go to the Hotel?</p>
        
        <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
        <div id="mode-switcher" class="mt-4 flex justify-center space-x-4">
            <button onclick="switchMode('menu')" id="btn-menu" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition">
                ğŸ¡ é¸å–®
            </button>
            <button onclick="switchMode('spelling')" id="btn-spelling" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-full hover:bg-purple-700 transition">
                ğŸ§  å–®å­—æ¸¬é©—
            </button>
            <button onclick="switchMode('grammar')" id="btn-grammar" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition">
                ğŸ“ æ–‡æ³•å¡«ç©º
            </button>
        </div>
    </header>

    <!-- 1. ä¸»é¸å–®æ¨¡å¼ (Home Screen) -->
    <section id="mode-menu" class="mode-view">
        <div class="text-center p-10 bg-blue-50 rounded-2xl shadow-inner">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">æ­¡è¿ä¾†åˆ° Unit 5 æŒ‘æˆ°ï¼</h2>
            <p class="text-xl text-gray-700 mb-8">è«‹é¸æ“‡ä½ æƒ³å¼·åŒ–çš„å­¸ç¿’æ¨¡å¼ï¼š</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="switchMode('spelling')" class="p-6 bg-purple-100 text-purple-800 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                    <span class="text-4xl">âœï¸</span>
                    <p class="text-2xl font-bold mt-2">å–®å­—æ‹¼å¯«æ©Ÿ</p>
                    <p class="text-sm mt-1">è¨˜æ†¶è¨“ç·´ï¼šè½ä¸­æ–‡ï¼Œæ‹¼å¯«è‹±æ–‡å–®å­—</p>
                </button>
                <button onclick="switchMode('grammar')" class="p-6 bg-indigo-100 text-indigo-800 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                    <span class="text-4xl">ğŸšŒ</span>
                    <p class="text-2xl font-bold mt-2">äº¤é€šæ–‡æ³•å¡«ç©º</p>
                    <p class="text-sm mt-1">æ‡‰ç”¨è¨“ç·´ï¼šå­¸ç¿’ by/take/ride/on foot èªæ³•</p>
                </button>
            </div>
        </div>
    </section>

    <!-- 2. å–®å­—æ¸¬é©—æ¨¡å¼ (Spelling Quiz) -->
    <section id="mode-spelling" class="mode-view hidden p-4">
        <h2 class="text-3xl font-bold text-purple-600 mb-6 text-center">ğŸ§  å–®å­—æ‹¼å¯«æŒ‘æˆ°</h2>
        <p class="text-sm font-semibold mb-4 text-center">
            ç›®å‰é€²åº¦: <span id="progress-display">0/10</span>
        </p>
        
        <!-- é–ƒå¡é¡¯ç¤ºå€ (ç°¡åŒ–ç‚ºéœæ…‹å¡ç‰‡) -->
        <div id="flashcard-static" class="flashcard-static w-full mb-4">
            <div class="text-center">
                <p class="text-xl mb-2 font-light text-gray-200">è«‹æ‹¼å‡ºæ­¤å–®å­—</p>
                <h2 class="text-5xl font-black mb-4" id="chinese-meaning"></h2> 
            </div>
        </div>

        <!-- ä¿®æ­£: æç¤ºè§£é‡‹å€ (å–ä»£åè½‰å¡ç‰‡) -->
        <div id="spelling-hint-area" class="w-full p-4 bg-gray-100 rounded-xl mb-8 text-center border-2 border-gray-300 shadow-inner">
            <p class="text-lg font-bold mb-1 text-gray-700">é»æ“Šå¡ç‰‡é¡¯ç¤ºè§£é‡‹èˆ‡æç¤º</p>
            <p class="text-xl italic text-gray-500 hidden" id="hint-text"></p>
            <p class="text-3xl font-bold mt-2 text-purple-600 hidden" id="spelling-result"></p>
        </div>
        
        <!-- è¼¸å…¥å€ -->
        <div class="flex flex-col space-y-4">
            <input type="text" id="spelling-input" class="w-full px-4 py-3 border-4 border-purple-400 rounded-xl text-2xl font-semibold focus:outline-none focus:border-purple-600 transition" placeholder="åœ¨æ­¤è¼¸å…¥è‹±æ–‡å–®å­—..." disabled>
            <button id="check-button" onclick="checkSpelling()" class="w-full py-3 bg-green-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-600 transition" disabled>
                æª¢æŸ¥æ‹¼å­—
            </button>
            <button id="next-button" onclick="nextWord()" class="w-full py-3 bg-purple-600 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-purple-700 transition hidden">
                ä¸‹ä¸€é¡Œ (Next)
            </button>
        </div>

        <!-- è¨Šæ¯æç¤ºå€ -->
        <div id="message-box" class="mt-6 p-4 text-center rounded-xl transition duration-500 hidden">
            <p class="text-lg font-semibold" id="message-text"></p>
        </div>
    </section>

    <!-- 3. æ–‡æ³•å¡«ç©ºæ¨¡å¼ (Grammar Fill-in) -->
    <section id="mode-grammar" class="mode-view hidden p-4">
        <h2 class="text-3xl font-bold text-indigo-600 mb-6 text-center">ğŸ“ äº¤é€šæ–‡æ³•å¡«ç©º</h2>

        <div id="grammar-challenge" class="bg-indigo-50 p-6 rounded-2xl mb-8 border-l-4 border-indigo-400">
            <p class="text-xl font-semibold text-gray-700 mb-4" id="grammar-question">è¼‰å…¥ä¸­...</p>
            <!-- èªæ³•çµæ§‹æ‹–æ›³å€ (Drop Zone) -->
            <div id="sentence-structure" class="text-3xl font-bold text-gray-800 flex flex-wrap items-center space-x-2 md:space-x-4">
                <!-- å¥å­çµæ§‹æœƒåœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>

        <!-- æ‹–æ›³é¸é …å€ (Drag Items) -->
        <div id="grammar-options" class="bg-gray-100 p-6 rounded-2xl shadow-inner">
            <h3 class="text-xl font-bold text-gray-600 mb-4">é¸é …ï¼š</h3>
            <div id="vehicle-options" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- å–®å­—å¡ç‰‡æœƒåœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>

        <!-- çµæœèˆ‡è¨Šæ¯æç¤ºå€ -->
        <div id="grammar-message-box" class="mt-8 p-4 text-center rounded-xl transition duration-500 hidden">
            <p class="text-2xl font-bold" id="grammar-message-text"></p>
            <button onclick="nextGrammarChallenge()" class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition shadow-lg">
                ä¸‹ä¸€é¡ŒæŒ‘æˆ°
            </button>
        </div>

        <!-- æç¤ºå€ (é¡¯ç¤ºå®Œæ•´æ­£ç¢ºå¥å­) -->
        <div id="grammar-hint-area" class="mt-4 p-4 text-sm text-gray-600 bg-gray-100 rounded-lg hidden">
            <p id="full-sentence-display" class="font-medium"></p>
        </div>
    </section>

</div>

<script>
    // =================================================================
    // 1. æ•¸æ“šå®šç¾© (Data Definitions)
    // =================================================================

    // A. å–®å­—æ¸¬é©—è³‡æ–™ (Vocabulary Data) - ä¾†è‡ª PDF Unit 5
    const vocabulary = [
        { word: "metro", meaning: "æ·é‹;åœ°éµ", hint: "äº¤é€šå·¥å…·ï¼šé€šå¸¸åœ¨åŸå¸‚åœ°ä¸‹é‹è¡Œ (Unit 5, No. 1)" },
        { word: "lost", meaning: "è¿·è·¯çš„", hint: "ç‹€æ…‹ï¼šæ‰¾ä¸åˆ°æ–¹å‘ (Unit 5, No. 2)" },
        { word: "map", meaning: "åœ°åœ–", hint: "ç‰©å“ï¼šå¹«åŠ©ä½ å°èˆªçš„ç´™æœ¬æˆ–é›»å­æ–‡ä»¶ (Unit 5, No. 3)" },
        { word: "ask", meaning: "è«‹æ±‚;è©¢å•", hint: "å‹•ä½œï¼šæå‡ºå•é¡Œæˆ–è¦æ±‚ (Unit 5, No. 4)" },
        { word: "excuse", meaning: "è—‰å£;ç†ç”±", hint: "åè©ï¼šç‚ºéŒ¯èª¤è¾¯è§£çš„èªªæ³• (Unit 5, No. 5)" },
        { word: "straight", meaning: "ç›´åœ°;ç›´çš„", hint: "æ–¹å‘ï¼šä¸è½‰å½çš„ (Unit 5, No. 6)" },
        { word: "ship", meaning: "è¼ªèˆ¹", hint: "äº¤é€šå·¥å…·ï¼šå¤§å‹çš„ï¼Œåœ¨æµ·ä¸Šèˆªè¡Œ (Unit 5, No. 21)" },
        { word: "taxi", meaning: "è¨ˆç¨‹è»Š", hint: "äº¤é€šå·¥å…·ï¼šé»ƒè‰²çš„ï¼Œéœ€è¦ä»˜è²»æ­ä¹˜ (Unit 5, No. 22)" },
        { word: "scooter", meaning: "æ©Ÿè»Š", hint: "äº¤é€šå·¥å…·ï¼šå…©è¼ªï¼Œå°ç£å¸¸è¦‹çš„ä»£æ­¥å·¥å…· (Unit 5, No. 25)" },
        { word: "hospital", meaning: "é†«é™¢", hint: "åœ°é»ï¼šç”Ÿç—…æˆ–å—å‚·æ™‚å»çœ‹é†«ç”Ÿçš„åœ°æ–¹ (Unit 5, No. 30)" }
    ];
    
    // B. æ–‡æ³•å¡«ç©ºè³‡æ–™ (Grammar Data) - ä¾†è‡ª PDF äº¤é€šå·¥å…·èªæ³•
    const grammarData = [
      {
        "id": 1,
        "question": "ä»–å€‘ç¸½æ˜¯ [__] [__] å»é‚£é–“åšç‰©é¤¨ã€‚",
        "structure": ["They always go to the museum", "ã€ä»‹ç³»è©ã€‘", "ã€è¼‰å…·ã€‘", "."],
        "targetVerb": "by",
        "targetVehicle": "metro",
        "vehicleText": "Metro (æ·é‹)",
        "icon": "ğŸš‡",
        "rule": "ä»‹ç³»è©ç”¨æ³•ï¼šä½¿ç”¨ 'by' æ™‚ï¼Œå¾Œé¢ç›´æ¥æ¥äº¤é€šå·¥å…·ï¼Œä¸­é–“ä¸åŠ å† è© a/theã€‚",
        "fullSentence": "They always go to the museum by metro."
      },
      {
        "id": 2,
        "question": "æˆ‘å€‘å¯ä»¥åœ¨é€™è£¡ [__] [__] è¨ˆç¨‹è»Šå›å®¶å—ï¼Ÿ",
        "structure": ["Can we", "ã€å‹•è©ã€‘", "a", "ã€è¼‰å…·ã€‘", "home here?"],
        "targetVerb": "take",
        "targetVehicle": "taxi",
        "vehicleText": "Taxi (è¨ˆç¨‹è»Š)",
        "icon": "ğŸš•",
        "rule": "å‹•è©ç”¨æ³•ï¼šä½¿ç”¨ 'take' æˆ– 'catch' æ™‚ï¼Œå¾Œé¢éœ€è¦åŠ ä¸Šå† è© a/the å†æ¥äº¤é€šå·¥å…·ã€‚",
        "fullSentence": "Can we take a taxi home here?"
      },
      {
        "id": 3,
        "question": "æˆ‘çš„æœ‹å‹å–œæ­¡ [__] [__] å–®è»Šæ²¿è‘—æ²³å²¸èµ°ã€‚",
        "structure": ["My friend likes to", "ã€å‹•è©ã€‘", "his", "ã€è¼‰å…·ã€‘", "along the bank."],
        "targetVerb": "ride",
        "targetVehicle": "bike",
        "vehicleText": "Bike (å–®è»Š)",
        "icon": "ğŸš²",
        "rule": "å‹•è©ç”¨æ³•ï¼šé¨ä¹˜å…©è¼ªæˆ–æœ‰åº§ä½çš„äº¤é€šå·¥å…·æ™‚ï¼Œå¸¸ä½¿ç”¨ 'ride'ã€‚",
        "fullSentence": "My friend likes to ride his bike along the bank."
      },
      {
        "id": 4,
        "question": "èŠ±åº—å¾ˆè¿‘ï¼Œæˆ‘å€‘ [__] [__] å»å§ï¼",
        "structure": ["The shop is close. Let's go there", "ã€ä»‹ç³»è©ã€‘", "ã€æ–¹å¼ã€‘", "."],
        "targetVerb": "on",
        "targetVehicle": "foot",
        "vehicleText": "Foot (èµ°è·¯)",
        "icon": "ğŸš¶",
        "rule": "ç‰¹æ®Šç”¨æ³•ï¼šèµ°è·¯ï¼ˆæ­¥è¡Œï¼‰æ˜¯ä¸€å€‹å›ºå®šç‰‡èªï¼Œå¿…é ˆä½¿ç”¨ 'on foot'ã€‚",
        "fullSentence": "The shop is close. Let's go there on foot."
      },
      {
        "id": 5,
        "question": "æˆ‘å€‘éœ€è¦åœ¨åœ–æ›¸é¤¨ [__] [__] é€™è¼›å…¬è»Šã€‚",
        "structure": ["We need to", "ã€å‹•è©ã€‘", "ã€ä»‹ç³»è©ã€‘", "the bus at the library."],
        "targetVerb": "get",
        "targetVehicle": "off",
        "vehicleText": "Off (ä¸‹è»Š)",
        "icon": "â¬‡ï¸",
        "rule": "å‹•è©ç‰‡èªï¼š'Get off' ç”¨æ–¼ä¸‹å¤§å‹äº¤é€šå·¥å…· (å…¬è»Šã€ç«è»Šã€æ·é‹)ã€‚",
        "fullSentence": "We need to get off the bus at the library."
      },
      {
        "id": 6,
        "question": "ä½ ä»Šå¤©æ—©ä¸Šæ˜¯ [__] [__] èˆ¹å»å°å°¼çš„å—ï¼Ÿ",
        "structure": ["Did you go to Indonesia", "ã€ä»‹ç³»è©ã€‘", "ã€è¼‰å…·ã€‘", "this morning?"],
        "targetVerb": "by",
        "targetVehicle": "ship",
        "vehicleText": "Ship (è¼ªèˆ¹)",
        "icon": "ğŸš¢",
        "rule": "ä»‹ç³»è©ç”¨æ³•ï¼šè©¢å•äº¤é€šæ–¹å¼æ™‚ï¼Œå¸¸ä½¿ç”¨ 'by' + äº¤é€šå·¥å…·ã€‚",
        "fullSentence": "Did you go to Indonesia by ship this morning?"
      }
    ];
    
    // æ‹–æ›³é¸é … (å¹²æ“¾é …)
    const extraOptions = [
        { key: "drive", text: "Drive (é–‹è»Š)", icon: "ğŸš—", type: 'verb' },
        { key: "with", text: "With (å’Œ)", icon: "ğŸ¤", type: 'verb' },
        { key: "a", text: "A (ä¸€å€‹)", icon: "1ï¸âƒ£", type: 'article' },
        { key: "on", text: "On (åœ¨ä¸Š)", icon: "ğŸ‘†", type: 'verb' }, 
        { key: "go", text: "Go (å»)", icon: "ğŸƒ", type: 'verb' },
        { key: "scooter", text: "Scooter (æ©Ÿè»Š)", icon: "ğŸ›µ", type: 'vehicle' }
    ];


    // =================================================================
    // 2. å…¨åŸŸç‹€æ…‹èˆ‡å…ƒç´ åƒè€ƒ (Global State and Element References)
    // =================================================================

    // æ¨¡å¼åˆ‡æ›ç‹€æ…‹
    let currentMode = 'menu';
    const modes = ['menu', 'spelling', 'grammar'];
    
    // å–®å­—æ¸¬é©—ç‹€æ…‹
    let currentWordIndex = 0;
    let spellingScore = 0;
    let currentQuiz = null;

    // æ–‡æ³•å¡«ç©ºç‹€æ…‹
    let currentGrammarIndex = 0;
    let dragData = {};

    // å…ƒç´ åƒè€ƒ (Spelling)
    const flashcardStaticEl = document.getElementById('flashcard-static'); // æ–°å¢çš„éœæ…‹å¡ç‰‡å…ƒç´ 
    const spellingHintAreaEl = document.getElementById('spelling-hint-area'); // æ–°å¢çš„æç¤ºå€
    const hintTitleEl = spellingHintAreaEl ? spellingHintAreaEl.querySelector('p:first-child') : null; // æç¤ºå€æ¨™é¡Œ

    const meaningEl = document.getElementById('chinese-meaning');
    const hintEl = document.getElementById('hint-text');
    const inputEl = document.getElementById('spelling-input');
    const checkBtn = document.getElementById('check-button');
    const nextBtn = document.getElementById('next-button');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const spellingResultEl = document.getElementById('spelling-result');
    const progressDisplay = document.getElementById('progress-display');


    // å…ƒç´ åƒè€ƒ (Grammar)
    const grammarQuestionEl = document.getElementById('grammar-question');
    const structureEl = document.getElementById('sentence-structure');
    const grammarOptionsEl = document.getElementById('vehicle-options');
    const grammarMessageBox = document.getElementById('grammar-message-box');
    const grammarMessageText = document.getElementById('grammar-message-text');
    const fullSentenceDisplay = document.getElementById('full-sentence-display');
    const grammarHintArea = document.getElementById('grammar-hint-area');
    
    // =================================================================
    // 3. æ¨¡å¼åˆ‡æ›é‚è¼¯ (Mode Switching Logic)
    // =================================================================

    document.addEventListener('DOMContentLoaded', () => {
        switchMode('menu');
        
        // *** ä¿®æ­£: ç¶å®šéœæ…‹å¡ç‰‡çš„é»æ“Šäº‹ä»¶ (ç”¨æ–¼é¡¯ç¤ºæç¤º) ***
        if (flashcardStaticEl) {
            flashcardStaticEl.addEventListener('click', toggleSpellingHint);
        }
    });

    function switchMode(mode) {
        if (!modes.includes(mode)) return;

        currentMode = mode;

        // éš±è—æ‰€æœ‰å…§å®¹å€å¡Š
        modes.forEach(m => {
            const el = document.getElementById(`mode-${m}`);
            if (el) el.classList.add('hidden');
            const btn = document.getElementById(`btn-${m}`);
            if (btn) btn.classList.remove('bg-purple-700', 'bg-indigo-700', 'text-white', 'bg-gray-300', 'text-gray-700');
        });
        
        // é¡¯ç¤ºç•¶å‰å€å¡Šä¸¦æ›´æ–°æŒ‰éˆ•æ¨£å¼
        const currentEl = document.getElementById(`mode-${mode}`);
        if (currentEl) currentEl.classList.remove('hidden');

        const currentBtn = document.getElementById(`btn-${mode}`);
        if (currentBtn) {
            if (mode === 'spelling') {
                currentBtn.classList.add('bg-purple-700', 'text-white');
            } else if (mode === 'grammar') {
                currentBtn.classList.add('bg-indigo-700', 'text-white');
            } else if (mode === 'menu') {
                 currentBtn.classList.add('bg-gray-300', 'text-gray-700');
            }
        }
        
        // æ¨¡å¼åˆå§‹åŒ–
        if (mode === 'spelling') {
            // æ´—ç‰Œä¸¦é–‹å§‹å–®å­—æ¸¬é©—
            vocabulary.sort(() => 0.5 - Math.random());
            currentWordIndex = 0;
            spellingScore = 0;
            startSpellingQuiz();
        } else if (mode === 'grammar') {
            // éš¨æ©Ÿæ’åˆ—ä¸¦é–‹å§‹æ–‡æ³•å¡«ç©º
            grammarData.sort(() => 0.5 - Math.random());
            currentGrammarIndex = 0;
            startGrammarChallenge();
        }
    }


    // =================================================================
    // 4. å–®å­—æ¸¬é©—é‚è¼¯ (Spelling Quiz Logic)
    // =================================================================

    function updateProgress() {
        progressDisplay.textContent = `${currentWordIndex}/${vocabulary.length}`;
    }

    function startSpellingQuiz() {
        if (currentWordIndex >= vocabulary.length) {
            endSpellingGame();
            return;
        }

        currentQuiz = vocabulary[currentWordIndex];
        
        // é‡ç½®ç‹€æ…‹
        inputEl.value = '';
        inputEl.focus();
        nextBtn.classList.add('hidden');
        checkBtn.classList.remove('hidden');
        messageBox.classList.add('hidden');
        inputEl.classList.remove('border-green-500', 'border-red-500');
        inputEl.disabled = false;
        checkBtn.disabled = false;
        
        // è¨­ç½®å¡ç‰‡æ­£é¢å…§å®¹ (ä¸­æ–‡æ„æ€)
        meaningEl.textContent = currentQuiz.meaning;
        
        // *** ä¿®æ­£: é‡ç½®æç¤ºå€ ***
        hintTitleEl.textContent = "é»æ“Šå¡ç‰‡é¡¯ç¤ºè§£é‡‹èˆ‡æç¤º"; // æç¤ºå€æ¨™é¡Œ
        hintEl.classList.add('hidden'); // éš±è—æç¤ºå…§å®¹
        spellingResultEl.classList.add('hidden'); // éš±è—çµæœ
    }
    
    // *** æ–°å¢: é»æ“Šå¡ç‰‡é¡¯ç¤ºæç¤ºé‚è¼¯ (å–ä»£åè½‰) ***
    function toggleSpellingHint() {
        if (checkBtn.classList.contains('hidden')) return; // ç­”é¡Œå¾Œé–å®š
        
        // å¦‚æœæç¤ºå…§å®¹æ˜¯éš±è—çš„ï¼Œå°±é¡¯ç¤ºå®ƒ
        if (hintEl.classList.contains('hidden')) {
             hintTitleEl.textContent = "å–®å­—æç¤ºï¼š";
             hintEl.classList.remove('hidden');
        } else {
             // å¦å‰‡ï¼Œéš±è—å®ƒ
             hintTitleEl.textContent = "é»æ“Šå¡ç‰‡é¡¯ç¤ºè§£é‡‹èˆ‡æç¤º";
             hintEl.classList.add('hidden');
        }
    }


    // æª¢æŸ¥æ‹¼å­—
    function checkSpelling() {
        const userInput = inputEl.value.toLowerCase().trim();
        const correctWord = currentQuiz.word.toLowerCase();

        inputEl.disabled = true;
        checkBtn.disabled = true;

        if (userInput === correctWord) {
            handleCorrectSpelling();
        } else {
            handleIncorrectSpelling(correctWord);
        }

        nextBtn.classList.remove('hidden');
    }

    function handleCorrectSpelling() {
        spellingScore++;
        messageBox.className = 'mt-6 p-4 text-center rounded-xl transition duration-500 bg-green-100 text-green-700 shadow-md';
        messageText.textContent = `âœ… æ‹¼å­—å®Œå…¨æ­£ç¢ºï¼å¤ªæ£’äº†ï¼ (Score: ${spellingScore})`;
        inputEl.classList.add('border-green-500');
        
        // ä¿®æ­£: é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
        hintTitleEl.textContent = "âœ… æ­£ç¢ºæ‹¼æ³•ï¼š";
        hintEl.classList.add('hidden'); // éš±è—æç¤º
        spellingResultEl.classList.remove('hidden'); // é¡¯ç¤ºçµæœ
        spellingResultEl.textContent = currentQuiz.word;
    }

    function handleIncorrectSpelling(correctWord) {
        messageBox.className = 'mt-6 p-4 text-center rounded-xl transition duration-500 bg-red-100 text-red-700 shadow-md';
        messageText.textContent = `âŒ æ‹¼å­—éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯...`;
        inputEl.classList.add('border-red-500');

        // ä¿®æ­£: é¡¯ç¤ºæ‰“å­—æ©Ÿç­”æ¡ˆ
        hintTitleEl.textContent = "âŒ æ­£ç¢ºæ‹¼æ³•ï¼š";
        hintEl.classList.add('hidden'); // éš±è—æç¤º
        spellingResultEl.classList.remove('hidden'); // é¡¯ç¤ºçµæœ

        spellingResultEl.textContent = '';
        typeWriterEffect(correctWord, spellingResultEl);
    }

    function typeWriterEffect(text, element) {
        let i = 0;
        element.classList.add('typewriter-text');
        
        const typingInterval = setInterval(() => {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
            } else {
                clearInterval(typingInterval);
                element.classList.remove('typewriter-text');
            }
        }, 100); 
    }

    function nextWord() {
        currentWordIndex++;
        setTimeout(() => {
            startSpellingQuiz();
        }, 500); 
    }

    function endSpellingGame() {
        inputEl.disabled = true;
        checkBtn.classList.add('hidden');
        nextBtn.classList.add('hidden');

        let finalMessage;
        if (spellingScore === vocabulary.length) {
            finalMessage = `ğŸ‰ æ­å–œï¼ä½ ä»¥æ»¿åˆ† ${spellingScore}/${vocabulary.length} å®Œæˆæ‰€æœ‰å–®å­—æ‹¼å¯«ï¼å¤ªå²å®³äº†ï¼`;
        } else if (spellingScore >= vocabulary.length / 2) {
            finalMessage = `ğŸ‘ æŒ‘æˆ°å®Œæˆï¼ä½ çš„åˆ†æ•¸æ˜¯ ${spellingScore}/${vocabulary.length}ã€‚è¡¨ç¾ä¸éŒ¯ï¼Œå†æ¥å†å²ï¼`;
        } else {
            finalMessage = `ğŸ’ª æŒ‘æˆ°å®Œæˆï¼ä½ çš„åˆ†æ•¸æ˜¯ ${spellingScore}/${vocabulary.length}ã€‚æ²’é—œä¿‚ï¼Œå¤šåŠ ç·´ç¿’å°±èƒ½æŒæ¡ï¼`;
        }

        messageBox.className = 'mt-6 p-4 text-center rounded-xl transition duration-500 bg-blue-100 text-blue-700 shadow-xl';
        messageText.textContent = finalMessage;
    }


    // =================================================================
    // 5. æ–‡æ³•å¡«ç©ºé‚è¼¯ (Grammar Fill-in Logic)
    // =================================================================

    function getVerbText(key) {
        switch (key) {
            case 'take': return 'Take (æ­ä¹˜)'; case 'ride': return 'Ride (é¨ä¹˜)'; case 'by': return 'By (è—‰ç”±)';
            case 'on': return 'On (åœ¨...ä¸Š)'; case 'get': return 'Get (å¾—åˆ°)'; case 'off': return 'Off (é›¢é–‹)';
            case 'foot': return 'Foot (è…³)'; default: return key.toUpperCase();
        }
    }
    function getVerbIcon(key) {
        switch (key) {
            case 'take': return 'ğŸ–ï¸'; case 'ride': return 'ğŸš´'; case 'by': return 'â©';
            case 'on': return 'â¬†ï¸'; case 'get': return 'â¡ï¸'; case 'off': return 'â¬‡ï¸';
            case 'foot': return 'ğŸ¦¶'; default: return 'â“';
        }
    }
    function getVerbType(key) {
        if (['take', 'ride', 'get'].includes(key)) return 'å‹•è©';
        if (['by', 'on', 'off'].includes(key)) return 'ä»‹ç³»è©';
        if (['foot', 'metro', 'taxi', 'bike', 'ship', 'scooter'].includes(key)) return 'è¼‰å…·';
        return 'å…¶ä»–';
    }


    function startGrammarChallenge() {
        if (currentGrammarIndex >= grammarData.length) {
            showGrammarResult('ğŸ‰ æ­å–œä½ ï¼ä½ å®Œæˆäº†æ‰€æœ‰çš„æ–‡æ³•æŒ‘æˆ°ï¼', 'success');
            return;
        }

        const currentChallenge = grammarData[currentGrammarIndex];
        grammarQuestionEl.textContent = currentChallenge.question;
        grammarMessageBox.classList.add('hidden');
        structureEl.innerHTML = '';
        grammarOptionsEl.innerHTML = '';
        grammarHintArea.classList.add('hidden');

        // éš¨æ©Ÿçµ„åˆé¸é …
        const requiredOptions = [
            { key: currentChallenge.targetVehicle, text: currentChallenge.vehicleText, icon: currentChallenge.icon, type: 'vehicle' },
            { key: currentChallenge.targetVerb, text: getVerbText(currentChallenge.targetVerb), icon: getVerbIcon(currentChallenge.targetVerb), type: getVerbType(currentChallenge.targetVerb) }
        ];

        const allOptions = [...requiredOptions, ...extraOptions]
            .filter((opt, i, self) => i === self.findIndex((t) => t.key === opt.key))
            .sort(() => 0.5 - Math.random());

        // æ¸²æŸ“èªæ³•çµæ§‹
        currentChallenge.structure.forEach(part => {
            const span = document.createElement('span');
            span.className = 'py-2';
            if (part.includes('ã€')) {
                span.className = 'drop-zone bg-white rounded-xl shadow-inner flex items-center justify-center p-2 min-w-[6rem] min-h-[3.5rem] border-2 border-dashed border-indigo-400 hover:border-indigo-600 transition-all text-xl md:text-2xl';
                span.dataset.targetType = part.replace(/[ã€ã€‘]/g, ''); 
                span.addEventListener('dragover', allowDrop);
                span.addEventListener('dragleave', handleDragLeave);
                span.addEventListener('drop', handleDrop);
                span.textContent = part;
            } else {
                span.className = 'text-2xl md:text-3xl font-bold text-indigo-700 py-2';
                span.textContent = part;
            }
            structureEl.appendChild(span);
        });

        // æ¸²æŸ“æ‹–æ›³é¸é …
        allOptions.forEach(option => {
            const item = createDragItem(option);
            grammarOptionsEl.appendChild(item);
        });
    }

    function createDragItem(option) {
        const item = document.createElement('div');
        item.className = `drag-item card bg-indigo-200 text-indigo-800 p-3 rounded-lg text-center shadow-md text-sm md:text-base font-semibold`;
        item.draggable = true;
        item.textContent = `${option.icon} ${option.text}`;
        item.dataset.key = option.key;
        item.dataset.type = option.type;
        item.addEventListener('dragstart', handleDragStart);
        return item;
    }

    function handleDragStart(e) {
        dragData = {
            key: e.target.dataset.key,
            type: e.target.dataset.type,
            element: e.target
        };
        setTimeout(() => e.target.classList.add('opacity-50'), 0); 
    }

    function allowDrop(e) {
        e.preventDefault();
        e.target.classList.add('bg-indigo-100'); 
    }

    function handleDragLeave(e) {
        e.target.classList.remove('bg-indigo-100');
    }

    function handleDrop(e) {
        e.preventDefault();
        const dropZone = e.currentTarget;
        dropZone.classList.remove('bg-indigo-100');

        const existingItem = dropZone.querySelector('.drag-item');
        if (existingItem) {
            existingItem.classList.remove('opacity-50', 'correct-animation', 'incorrect-animation');
            grammarOptionsEl.appendChild(existingItem);
        }

        dragData.element.classList.remove('opacity-50');
        dropZone.innerHTML = '';
        dropZone.appendChild(dragData.element); 
        
        // é—œéµä¿®å¾©ï¼šç¢ºä¿ DOM å…ƒç´ æ­£ç¢ºè­˜åˆ¥
        if (!dropZone.querySelector('.drag-item')) {
             dropZone.textContent = `ã€${dropZone.dataset.targetType}ã€‘`;
             return; 
        }

        dropZone.classList.remove('border-dashed');
        dropZone.classList.add('border-solid', 'border-indigo-600', 'shadow-lg');

        checkGrammarCompletion();
    }

    function checkGrammarCompletion() {
        const dropZones = structureEl.querySelectorAll('.drop-zone');
        let filledCount = 0;
        let isCorrect = true;
        let droppedKeys = {}; 

        dropZones.forEach(zone => {
            const item = zone.querySelector('.drag-item');
            if (item) {
                filledCount++;
                const expectedType = zone.dataset.targetType;
                droppedKeys[expectedType] = item.dataset.key;
            }
        });

        if (filledCount === dropZones.length) {
            const currentChallenge = grammarData[currentGrammarIndex];
            
            const verbKey = droppedKeys['å‹•è©'] || droppedKeys['ä»‹ç³»è©'];
            const vehicleKey = droppedKeys['è¼‰å…·'] || droppedKeys['æ–¹å¼'];
            
            // æª¢æŸ¥ targetVerb (å‹•è©/ä»‹ç³»è©) æ­£ç¢ºæ€§
            if (verbKey !== currentChallenge.targetVerb) { isCorrect = false; }
            // æª¢æŸ¥ targetVehicle/æ–¹å¼ (è¼‰å…·/æ–¹å¼/ä»‹ç³»è©ç‰‡èª) æ­£ç¢ºæ€§
            if (vehicleKey !== currentChallenge.targetVehicle) { isCorrect = false; }
            
            // è™•ç† get off é€™ç¨®é›™æ¬„ä½å‹•è©ç‰‡èª
            if (currentChallenge.targetVerb === 'get' && currentChallenge.targetVehicle === 'off') {
                if (droppedKeys['å‹•è©'] !== 'get' || droppedKeys['ä»‹ç³»è©'] !== 'off') {
                    isCorrect = false;
                }
            }


            // é¡¯ç¤ºçµæœ
            const resultType = isCorrect ? 'success' : 'error';
            const resultText = isCorrect ? `âœ… å¤ªæ£’äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentChallenge.fullSentence}` : `âŒ ç­”éŒ¯äº†ï¼Œè«‹å†æƒ³æƒ³ï¼æç¤ºï¼š${currentChallenge.rule}`;
            showGrammarResult(resultText, resultType);
            
            const items = structureEl.querySelectorAll('.drag-item');
            if (isCorrect) {
                items.forEach(item => item.classList.add('correct-animation'));
            } else {
                items.forEach(item => item.classList.add('incorrect-animation'));
                setTimeout(() => {
                    fullSentenceDisplay.textContent = `å®Œæ•´æ­£ç¢ºå¥å­ï¼š${currentChallenge.fullSentence}`;
                    grammarHintArea.classList.remove('hidden');
                }, 1000);
            }
        }
    }

    function showGrammarResult(text, type) {
        grammarMessageText.textContent = text;
        grammarMessageBox.classList.remove('hidden');
        if (type === 'success') {
            grammarMessageBox.className = 'mt-8 p-4 text-center rounded-xl transition duration-500 bg-green-100 text-green-700 shadow-xl';
        } else {
            grammarMessageBox.className = 'mt-8 p-4 text-center rounded-xl transition duration-500 bg-red-100 text-red-700 shadow-xl';
        }
    }
    
    function nextGrammarChallenge() {
        currentGrammarIndex++;
        startGrammarChallenge();
    }
</script>
</body>
</html>
